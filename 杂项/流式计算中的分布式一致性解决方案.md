## 常见流处理框架的可靠性保障机制



[漫谈流式计算的一致性](https://www.cnblogs.com/fxjwind/p/4975389.html)<http://www.cnblogs.com/fxjwind/p/4975389.html> 

### Storm ack机制

特点：1、保证at-least-once；2、不保证中间状态结果；3、对业务逻辑实现和性能都有影响；

![image-20180805035936843](assets/image-20180805035936843.png)



### Micro Batch

Spark Streaming / Storm Trident

特点：1、保证Exactly-Once消息处理；2、保证中间状态结果；3、延迟、编程模型，流控；

![image-20180805040202804](assets/image-20180805040202804.png)

### Transaction Update 

 ![image-20180805040337329](assets/image-20180805040337329.png)



## Flink分布式快照介绍

1. 定期保存分布式快照
2. 发生节点宕机等异常
3. 重启所有task;恢复到上一次分布式快照状态
4. 从source重发分布式快照之后的消息

􏰁􏰊􏰍􏰅􏱃 􏰛 􏱦􏰁􏰑􏰃 􏰋 􏰕􏱦􏰫􏰤 分布式快照  = 部分数据 * 全部计算  ？？



### 分布式快照流程

1、触发阶段

• Trigger Vertices: Input vertices 

 • ACK Vertices: all job vertices  

• Commit Vertices: all job vertices 

2、快照阶段

• BarrierBuffer: 处理所有􏰦􏰧􏱚􏰓Task􏰈􏰷􏰸的消息

 • StreamTask􏱍􏱣􏰑􏱚􏰓：通知所有Operator􏰙􏰱 快照

 • Operator􏱍􏱧􏰻执行UDF自定义􏰡􏰿􏱨snapshot􏱠􏱩 方法

3、响应阶段

Task: 􏱦􏰇􏰙􏰱􏰆􏰁􏱺完成快照后发送ACK
 • CheckpointCoordinator：收到所有􏱍􏱡􏰚􏱚􏰓task快照后，将快照信息记录下来

􏰙􏰱􏰆􏱐􏱞􏰙􏰱􏰽􏰸 • CheckpointCoordinator􏱍􏰁􏱺：发送commit消息给所有task

4、恢复阶段

TaskManager崩溃

CheckpointCoordinator 读取最近一次成功快照信息

JobManager将每一task的快照信息保存在TaskDeploymentDescriptor中，

重启所有task

TaskManager：Task启动时首先从存储中加载快照数据。



## 分布式快照：总结

正确性保证

低延迟

高通吐量

强大的编程范式

​	正确性保证的设计不影响流处理编程范式的实现

​	对业务逻辑无侵入

较低的系统代价

流控