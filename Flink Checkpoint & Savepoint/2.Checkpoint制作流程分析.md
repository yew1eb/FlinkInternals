 Flink-分布式快照的设计-流程  http://chenyuzhao.me/2018/01/29/Flink-%E5%88%86%E5%B8%83%E5%BC%8F%E5%BF%AB%E7%85%A7%E7%9A%84%E8%AE%BE%E8%AE%A1-%E6%B5%81%E7%A8%8B/



## Flink分布式快照介绍

1. 定期保存分布式快照
2. 发生节点宕机等异常
3. 重启所有task;恢复到上一次分布式快照状态
4. 从source重发分布式快照之后的消息

􏰁􏰊􏰍􏰅􏱃 􏰛 􏱦􏰁􏰑􏰃 􏰋 􏰕􏱦􏰫􏰤 分布式快照  = 部分数据 * 全部计算  ？？



### 分布式快照流程

1、触发阶段

• Trigger Vertices: Input vertices 

 • ACK Vertices: all job vertices  

• Commit Vertices: all job vertices 

2、快照阶段

• BarrierBuffer: 处理所有􏰦􏰧􏱚􏰓Task􏰈􏰷􏰸的消息

 • StreamTask􏱍􏱣􏰑􏱚􏰓：通知所有Operator􏰙􏰱 快照

 • Operator􏱍􏱧􏰻执行UDF自定义􏰡􏰿􏱨snapshot􏱠􏱩 方法

3、响应阶段

Task: 􏱦􏰇􏰙􏰱􏰆􏰁􏱺完成快照后发送ACK
 • CheckpointCoordinator：收到所有􏱍􏱡􏰚􏱚􏰓task快照后，将快照信息记录下来

􏰙􏰱􏰆􏱐􏱞􏰙􏰱􏰽􏰸 • CheckpointCoordinator􏱍􏰁􏱺：发送commit消息给所有task

4、恢复阶段

TaskManager崩溃

CheckpointCoordinator 读取最近一次成功快照信息

JobManager将每一task的快照信息保存在TaskDeploymentDescriptor中，

重启所有task

TaskManager：Task启动时首先从存储中加载快照数据。